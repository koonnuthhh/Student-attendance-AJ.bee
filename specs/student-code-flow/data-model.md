# Student Code Flow - Data Model

## Entity Changes

### User Entity Updates
```typescript
@Entity('users')
export class User extends BaseEntity {
  // ... existing fields

  @Column({ 
    unique: true, 
    nullable: true, 
    length: 8,
    comment: 'Unique student identification code for class enrollment'
  })
  studentCode?: string;

  @Column({
    type: 'timestamp',
    nullable: true,
    comment: 'When the student code was generated'
  })
  studentCodeGeneratedAt?: Date;

  @Column({
    default: false,
    comment: 'Whether the student code has been used for registration'
  })
  studentCodeUsed?: boolean;

  // ... existing relationships
}
```

### New StudentCode Entity (Optional - for tracking)
```typescript
@Entity('student_codes')
export class StudentCode extends BaseEntity {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ unique: true, length: 8 })
  code: string;

  @Column({ default: false })
  used: boolean;

  @Column({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  generatedAt: Date;

  @Column({ type: 'timestamp', nullable: true })
  usedAt?: Date;

  @ManyToOne(() => User, { nullable: true })
  @JoinColumn({ name: 'generated_by' })
  generatedBy?: User;

  @ManyToOne(() => User, { nullable: true })
  @JoinColumn({ name: 'assigned_to' })
  assignedTo?: User;

  @ManyToOne(() => Class, { nullable: true })
  @JoinColumn({ name: 'class_id' })
  class?: Class;
}
```

## Database Migration

### Migration File: AddStudentCodeToUsers
```typescript
export class AddStudentCodeToUsers1734567890123 implements MigrationInterface {
  name = 'AddStudentCodeToUsers1734567890123';

  public async up(queryRunner: QueryRunner): Promise<void> {
    // Add studentCode column
    await queryRunner.addColumn(
      'users',
      new TableColumn({
        name: 'student_code',
        type: 'varchar',
        length: '8',
        isNullable: true,
        isUnique: true,
        comment: 'Unique student identification code for class enrollment',
      })
    );

    // Add studentCodeGeneratedAt column
    await queryRunner.addColumn(
      'users',
      new TableColumn({
        name: 'student_code_generated_at',
        type: 'timestamp',
        isNullable: true,
        comment: 'When the student code was generated',
      })
    );

    // Add studentCodeUsed column
    await queryRunner.addColumn(
      'users',
      new TableColumn({
        name: 'student_code_used',
        type: 'boolean',
        default: false,
        comment: 'Whether the student code has been used for registration',
      })
    );

    // Create unique index
    await queryRunner.createIndex(
      'users',
      new TableIndex({
        name: 'IDX_USERS_STUDENT_CODE',
        columnNames: ['student_code'],
        isUnique: true,
        where: 'student_code IS NOT NULL',
      })
    );
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    await queryRunner.dropIndex('users', 'IDX_USERS_STUDENT_CODE');
    await queryRunner.dropColumn('users', 'student_code_used');
    await queryRunner.dropColumn('users', 'student_code_generated_at');
    await queryRunner.dropColumn('users', 'student_code');
  }
}
```

## API Request/Response Models

### Registration with Student Code
```typescript
// Request
interface RegisterWithCodeRequest {
  email: string;
  name: string;
  password: string;
  studentCode: string;
}

// Response
interface RegisterWithCodeResponse {
  user: {
    id: string;
    email: string;
    name: string;
    status: string;
    roles: string[];
    studentCode: string;
  };
  accessToken: string;
  assignedClasses: Array<{
    id: string;
    name: string;
    subject: string;
    teacher: string;
  }>;
}
```

### Student Code Validation
```typescript
// Request: GET /student-codes/validate/:code

// Response
interface ValidateCodeResponse {
  isValid: boolean;
  isUsed: boolean;
  associatedClasses?: Array<{
    id: string;
    name: string;
    subject: string;
    teacher: string;
  }>;
}
```

### Student Code Generation
```typescript
// Request
interface GenerateCodeRequest {
  classId: string;
  quantity?: number; // Default: 1
}

// Response
interface GenerateCodeResponse {
  codes: Array<{
    code: string;
    classId: string;
    className: string;
    generatedAt: Date;
  }>;
}
```

## Business Rules

### Student Code Format
- **Length**: Exactly 8 characters
- **Characters**: Uppercase letters and numbers only
- **Pattern**: XXXX-XXXX (displayed with hyphen, stored without)
- **Uniqueness**: Globally unique across all users
- **Case**: Always uppercase

### Code Generation Rules
- Generated by teachers only
- Associated with specific class
- Cannot be regenerated once used
- Expire after 30 days if unused
- Maximum 50 unused codes per class

### Registration Rules
- Student code is optional during registration
- If provided, must be valid and unused
- Student is automatically enrolled in associated classes
- Code is marked as used upon successful registration
- Invalid codes prevent registration

### Enrollment Rules
- Students with codes are auto-enrolled in associated classes
- Teachers can still manually add students (existing flow)
- Students can only be in classes they were assigned to via code
- No self-enrollment without valid code

## Relationships

### Updated User-Class Relationship
```
User (Student with studentCode)
    ↓ (via Enrollment)
Class (assigned via code)
    ↓ (has many)
Session
    ↓ (attendance for)
AttendanceRecord
```

### Code-Class Association
```
Teacher (generates)
    ↓
StudentCode (for specific)
    ↓
Class (enables enrollment in)
    ↓
Student (registers with code)
```

## Constraints and Indexes

### Database Constraints
```sql
-- Unique student code
ALTER TABLE users ADD CONSTRAINT uk_users_student_code UNIQUE (student_code);

-- Student code format check
ALTER TABLE users ADD CONSTRAINT ck_student_code_format 
  CHECK (student_code ~ '^[A-Z0-9]{8}$');

-- Code generation timestamp consistency
ALTER TABLE users ADD CONSTRAINT ck_code_timestamp
  CHECK ((student_code IS NULL AND student_code_generated_at IS NULL) OR 
         (student_code IS NOT NULL AND student_code_generated_at IS NOT NULL));
```

### Performance Indexes
```sql
-- Fast student code lookups
CREATE INDEX idx_users_student_code_lookup ON users(student_code) 
  WHERE student_code IS NOT NULL;

-- Unused codes tracking
CREATE INDEX idx_users_unused_codes ON users(student_code_used, student_code_generated_at)
  WHERE student_code IS NOT NULL;

-- Class-based code queries
CREATE INDEX idx_enrollments_student_code ON enrollments(student_id)
  WHERE student_id IN (SELECT id FROM users WHERE student_code IS NOT NULL);
```